# Lightpanda Browser Evaluation

**Date:** 2025-12-07
**Evaluator:** Claude
**Repository:** https://github.com/lightpanda-io/browser
**Status:** Beta

## Executive Summary

**Recommendation: NOT RECOMMENDED for production use at this time.**

Lightpanda is a promising open-source headless browser written in Zig that claims significant performance improvements (11x faster, 9x less memory) over Chrome. However, its beta status, incomplete Web API coverage, and unknown compatibility with our specific Disney session extraction requirements make it unsuitable for our production use case.

## Current Playwright Usage Analysis

Our `SessionManager` (src/clients/session-manager.ts) uses the following Playwright features:

| Feature | Usage | Lightpanda Support |
|---------|-------|-------------------|
| `chromium.launch({ headless })` | Start browser | ✅ Via CDP |
| `browser.newContext()` with userAgent, viewport, locale, timezoneId | Configure session | ⚠️ Partial |
| `page.goto(url, { waitUntil, timeout })` | Navigate to Disney | ✅ Likely |
| `page.$(selector)` | Query DOM | ✅ Supported |
| `element.click()` | Click consent banner | ✅ Supported |
| `page.waitForTimeout()` | Fixed delays | ⚠️ Unknown |
| `context.cookies()` | Extract auth cookies | ⚠️ Unknown |
| `context.storageState()` | Get cookies + localStorage | ❌ Unknown |
| JavaScript execution (client-side JWT generation) | Critical for `__d` cookie | ✅ Uses V8 |

### Critical Dependency: Client-Side JWT Generation

Disney's authentication cookie (`__d`) is generated by JavaScript after page load. This is the most critical requirement. Lightpanda uses V8 for JavaScript execution, which should theoretically support this, but Disney's JS may use Web APIs that Lightpanda doesn't fully implement.

## Lightpanda Capabilities

### Confirmed Features
- JavaScript execution via V8 engine
- DOM APIs (createElement, querySelector, etc.)
- Ajax support (XHR and Fetch)
- Click actions and form input
- Cookie and custom header support
- Proxy support and network interception
- CDP/WebSocket server (Playwright-compatible)

### Limitations
- **Beta status** with explicit warning: "You may still encounter errors or crashes"
- Incomplete Web API coverage ("There are hundreds of Web APIs")
- Playwright compatibility has caveats about "different code paths"
- No GUI mode (headless only) - can't debug visually

## Performance Claims

From Lightpanda benchmarks (100-page Puppeteer test on AWS m5.large):

| Metric | Chrome/Puppeteer | Lightpanda | Improvement |
|--------|-----------------|------------|-------------|
| Memory | ~110 MB avg | ~12 MB avg | 9x less |
| Speed | ~900ms/page | ~80ms/page | 11x faster |
| Startup | ~2-3 seconds | Instant | Significant |

These improvements are impressive but less relevant for our use case where:
1. Sessions are refreshed every 8 hours (not high-frequency)
2. Only 2 destinations (WDW, DLR) need sessions
3. Memory/speed aren't bottlenecks currently

## Risk Assessment

### High Risk ⛔
1. **Web API Coverage Gaps**: Disney's website uses modern JS features. Unknown if Lightpanda implements all required APIs.
2. **Cookie/Storage Extraction**: Our exact usage of `context.storageState()` may not work identically.
3. **No Fallback**: If Lightpanda fails, we lose Disney API access entirely.
4. **Debugging Difficulty**: No visual browser mode makes troubleshooting harder.

### Medium Risk ⚠️
1. **OneTrust Compatibility**: Cookie consent handling requires DOM interaction; may behave differently.
2. **Timezone/Locale**: Configuration options may not match Playwright's API.
3. **Maintenance Burden**: Beta software requires more frequent updates and fixes.

### Low Risk ✅
1. **V8 JavaScript Engine**: Same engine as Chrome, so core JS should work.
2. **CDP Protocol**: Standard protocol with good compatibility.

## If We Wanted to Proceed

### Testing Strategy

1. **Create test branch** with Lightpanda integration
2. **Manual validation**:
   ```bash
   # Start Lightpanda CDP server
   ./lightpanda serve --host 127.0.0.1 --port 9222

   # Connect via Playwright
   const browser = await chromium.connectOverCDP('http://127.0.0.1:9222');
   ```
3. **Test cookie extraction** against both WDW and DLR
4. **Verify JWT generation** - check if `__d` cookie appears
5. **Compare session validity** with Playwright-generated sessions

### Migration Path (If Tests Pass)

1. Add Lightpanda as optional browser backend
2. Configure via `MOUSE_MCP_BROWSER=lightpanda` env var
3. Keep Playwright as default/fallback
4. Monitor error rates over 2-week trial

## Alternatives Considered

| Alternative | Pros | Cons |
|-------------|------|------|
| **Keep Playwright** | Battle-tested, full API | Higher memory/CPU |
| **Puppeteer** | Lighter than Playwright | Still uses full Chrome |
| **Lightpanda** | Fastest, lowest memory | Beta, incomplete APIs |
| **Direct API Auth** | No browser needed | Disney doesn't expose auth endpoints |

## Decision

**Stick with Playwright** for the following reasons:

1. **Reliability over performance**: Session management is critical infrastructure. Downtime = no Disney API access.

2. **Low session frequency**: We refresh sessions every 8 hours, not per-request. Browser overhead is negligible.

3. **Production readiness**: Playwright is battle-tested; Lightpanda explicitly warns of crashes.

4. **Debugging capability**: Playwright's `MOUSE_MCP_SHOW_BROWSER=true` enables visual debugging.

5. **No compelling ROI**: The memory/speed gains don't justify the risk for our use case.

## Future Reconsideration

Revisit this decision when:

- Lightpanda reaches stable release (v1.0+)
- Web API coverage significantly expands
- Someone validates Disney.com specifically works
- We need to scale to many more concurrent sessions

## References

- [Lightpanda GitHub](https://github.com/lightpanda-io/browser)
- [Lightpanda Website](https://lightpanda.io)
- [CDP Protocol Spec](https://chromedevtools.github.io/devtools-protocol/)
- [Playwright CDP Docs](https://playwright.dev/docs/api/class-browsertype#browser-type-connect-over-cdp)
